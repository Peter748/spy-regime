<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPY Regime Chart</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0d1117; color: #e6edf3;
  font-family: 'Courier New', monospace;
  padding: 24px 20px; min-height: 100vh;
}
h1 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
.sub { font-size: 11px; color: #484f58; margin-bottom: 20px; }
.top-bar {
  display: flex; align-items: center; gap: 16px;
  background: #161b22; border: 1px solid #21262d;
  border-radius: 8px; padding: 14px 18px; margin-bottom: 18px;
  flex-wrap: wrap;
}
.metric { min-width: 90px; }
.metric .label { font-size: 10px; color: #484f58; margin-bottom: 3px; }
.metric .value { font-size: 18px; font-weight: 700; }
.metric .small { font-size: 13px; font-weight: 600; }
.pill {
  display: inline-block; border-radius: 20px;
  padding: 4px 12px; font-size: 12px; font-weight: 700;
  border: 1px solid; margin-left: 12px; vertical-align: middle;
}
.stats { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
.stat-card {
  flex: 1; min-width: 120px; border-radius: 8px;
  padding: 10px 14px; border: 1px solid;
}
.stat-card .s-label { font-size: 10px; color: #484f58; margin-bottom: 3px; }
.stat-card .s-val { font-size: 20px; font-weight: 700; }
.stat-card .s-sub { font-size: 10px; color: #484f58; }
.controls {
  display: flex; gap: 6px; margin-bottom: 16px;
  flex-wrap: wrap; align-items: center;
}
button {
  background: #161b22; color: #666;
  border: 1px solid #21262d; border-radius: 6px;
  padding: 6px 13px; cursor: pointer;
  font-family: 'Courier New', monospace;
  font-size: 11px; font-weight: 700;
  transition: all 0.15s;
}
button.active { background: #f0a50022; color: #f0a500; border-color: #f0a500; }
button.active-blue { background: #60a5fa22; color: #60a5fa; border-color: #60a5fa; }
button.active-green { background: #00d68f22; color: #00d68f; border-color: #00d68f; }
button:hover { opacity: 0.8; }
.chart-wrap {
  background: #0d1117; border: 1px solid #21262d;
  border-radius: 12px; padding: 16px; margin-bottom: 16px;
  position: relative;
}
#loading {
  position: absolute; inset: 0; display: flex;
  align-items: center; justify-content: center;
  flex-direction: column; gap: 12px; background: #0d1117;
  border-radius: 12px; z-index: 10;
}
.spinner {
  width: 32px; height: 32px; border: 3px solid #21262d;
  border-top-color: #f0a500; border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.error-box {
  background: #ff4d6d11; border: 1px solid #ff4d6d44;
  border-radius: 8px; padding: 16px; color: #ff4d6d;
  font-size: 12px; margin-bottom: 16px; display: none;
}
.footer { font-size: 10px; color: #30363d; text-align: center; margin-top: 12px; }
.year-btns { display: flex; gap: 5px; flex-wrap: wrap; }
.view-btns { display: flex; gap: 5px; margin-left: 12px; }
.gran-btns { display: flex; gap: 5px; margin-left: auto; }
canvas { max-height: 400px; }
</style>
</head>
<body>

<h1>SPY Market Regime 
  <span id="regime-pill" class="pill" style="display:none"></span>
</h1>
<div class="sub">Real SPY data Â· EMA(20) + EMA(50) + ADX(14) Â· Same algorithm as your trading bot</div>

<div class="error-box" id="error-box"></div>

<div class="top-bar" id="top-bar" style="display:none">
  <div class="metric">
    <div class="label">LAST CLOSE</div>
    <div class="value" id="m-price">-</div>
  </div>
  <div class="metric">
    <div class="label">CHANGE</div>
    <div class="small" id="m-change">-</div>
  </div>
  <div class="metric">
    <div class="label">EMA 20</div>
    <div class="small" style="color:#60a5fa" id="m-ema20">-</div>
  </div>
  <div class="metric">
    <div class="label">EMA 50</div>
    <div class="small" style="color:#a78bfa" id="m-ema50">-</div>
  </div>
  <div class="metric">
    <div class="label">ADX (14)</div>
    <div class="small" style="color:#fb923c" id="m-adx">-</div>
  </div>
  <div class="metric" style="margin-left:auto">
    <div class="label">BOT STRATEGY</div>
    <div class="small" id="m-strategy">-</div>
  </div>
  <button onclick="loadData()" style="color:#60a5fa;border-color:#60a5fa44;margin-left:8px">â†» Refresh</button>
</div>

<div class="stats" id="stats-row" style="display:none">
  <div class="stat-card" style="background:#00d68f12;border-color:#00d68f30">
    <div class="s-label">ğŸ‚ BULL DAYS</div>
    <div class="s-val" id="s-bull" style="color:#00d68f">-</div>
    <div class="s-sub" id="s-bull-pct">Trend Following</div>
  </div>
  <div class="stat-card" style="background:#ff4d6d12;border-color:#ff4d6d30">
    <div class="s-label">ğŸ» BEAR DAYS</div>
    <div class="s-val" id="s-bear" style="color:#ff4d6d">-</div>
    <div class="s-sub" id="s-bear-pct">Hold Cash</div>
  </div>
  <div class="stat-card" style="background:#f0a50012;border-color:#f0a50030">
    <div class="s-label">ã€°ï¸ CHOPPY DAYS</div>
    <div class="s-val" id="s-choppy" style="color:#f0a500">-</div>
    <div class="s-sub" id="s-choppy-pct">Mean Reversion</div>
  </div>
</div>

<div class="controls">
  <div class="year-btns" id="year-btns"></div>
  <div class="view-btns">
    <button id="btn-price" class="active-blue" onclick="setView('price')">Price Chart</button>
    <button id="btn-regime" onclick="setView('regime')">Regime Days</button>
  </div>
  <div class="gran-btns">
    <button id="btn-daily" class="active" onclick="setGran('daily')">Daily</button>
    <button id="btn-monthly" onclick="setGran('monthly')">Monthly</button>
  </div>
</div>

<div class="chart-wrap">
  <div id="loading">
    <div class="spinner"></div>
    <div style="color:#484f58;font-size:12px">Fetching real SPY data...</div>
  </div>
  <canvas id="chart"></canvas>
</div>

<div class="footer">
  Data: Yahoo Finance Â· Regime: EMA(20/50) + ADX(14) matching your bot's regime_detector.py
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allData = [];
let chartInst = null;
let currentView = 'price';
let currentGran = 'daily';
let currentYear = 'ALL';

const C = { BULL:'#00d68f', BEAR:'#ff4d6d', CHOPPY:'#f0a500', UNKNOWN:'#444' };

// â”€â”€ Regime math (mirrors bot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcEMA(vals, period) {
  const k = 2/(period+1), out = new Array(vals.length).fill(null);
  let sum=0, cnt=0;
  for (let i=0;i<vals.length;i++) {
    if (vals[i]==null) continue;
    if (cnt<period) { sum+=vals[i]; cnt++; if(cnt===period) out[i]=sum/period; }
    else out[i]=vals[i]*k+out[i-1]*(1-k);
  }
  return out;
}

function calcADX(H,L,C,p=14) {
  const n=C.length, res=new Array(n).fill(null);
  const tr=[],pDM=[],mDM=[];
  for(let i=1;i<n;i++){
    tr.push(Math.max(H[i]-L[i],Math.abs(H[i]-C[i-1]),Math.abs(L[i]-C[i-1])));
    const u=H[i]-H[i-1],d=L[i-1]-L[i];
    pDM.push(u>d&&u>0?u:0); mDM.push(d>u&&d>0?d:0);
  }
  function ws(a,p){
    const o=new Array(a.length).fill(null);
    let s=a.slice(0,p).reduce((x,y)=>x+y,0); o[p-1]=s;
    for(let i=p;i<a.length;i++) o[i]=o[i-1]-o[i-1]/p+a[i];
    return o;
  }
  const sTR=ws(tr,p),sP=ws(pDM,p),sM=ws(mDM,p);
  const dx=[];
  for(let i=p-1;i<sTR.length;i++){
    if(!sTR[i]){dx.push(0);continue;}
    const pi=sP[i]/sTR[i]*100,mi=sM[i]/sTR[i]*100;
    dx.push((pi+mi)===0?0:Math.abs(pi-mi)/(pi+mi)*100);
  }
  let av=null; const aa=[];
  for(let i=0;i<dx.length;i++){
    if(i<p){aa.push(null);continue;}
    if(av===null){av=dx.slice(0,p).reduce((a,b)=>a+(b||0),0)/p; aa.push(av);}
    else{av=(av*(p-1)+(dx[i]||0))/p; aa.push(av);}
  }
  for(let i=0;i<aa.length;i++) if(i+1<n) res[i+1]=aa[i];
  // Forward-fill any trailing nulls with last valid ADX value
  // (last ~p bars sometimes return null due to Wilder smoothing offset)
  let lastValid=null;
  for(let i=0;i<res.length;i++){
    if(res[i]!==null) lastValid=res[i];
    else if(lastValid!==null) res[i]=lastValid;
  }
  return res;
}

function regime(close,e20,e50,adx){
  // If ADX unavailable (insufficient history), use EMA position only
  if(!e20||!e50) return 'UNKNOWN';
  const pct=(close-e50)/e50*100;
  if(!adx) {
    // Fallback: classify by price vs EMAs alone (no ADX filter)
    if(close>e20&&close>e50&&pct>3) return 'BULL';
    if(close<e20&&close<e50&&pct<-3) return 'BEAR';
    return 'CHOPPY';
  }
  if(adx>25){
    if(close>e20&&close>e50&&pct>3) return 'BULL';
    if(close<e20&&close<e50&&pct<-3) return 'BEAR';
    return 'CHOPPY';
  }
  return 'CHOPPY';
}

// â”€â”€ Fetch SPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSPY() {
  const base = 'https://query1.finance.yahoo.com/v8/finance/chart/SPY?interval=1d&range=4y&events=history';
  const proxies = [
    base,
    'https://corsproxy.io/?url=' + encodeURIComponent(base),
    'https://api.allorigins.win/raw?url=' + encodeURIComponent(base),
  ];
  for (const url of proxies) {
    try {
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      if (!r.ok) continue;
      const j = await r.json();
      const result = j.chart?.result?.[0];
      if (!result) continue;
      const ts = result.timestamp;
      const q  = result.indicators.quote[0];
      const rows = [];
      for (let i=0;i<ts.length;i++) {
        if (!q.close[i]) continue;
        const d = new Date(ts[i]*1000);
        if (d.getDay()===0||d.getDay()===6) continue;
        rows.push({
          date:  d.toISOString().slice(0,10),
          open:  +q.open[i].toFixed(2),
          high:  +q.high[i].toFixed(2),
          low:   +q.low[i].toFixed(2),
          close: +q.close[i].toFixed(2),
        });
      }
      if (rows.length > 50) return rows;
    } catch(e) { console.warn('fetch failed:', url, e.message); }
  }
  throw new Error('All data sources blocked. Try running locally with: python -m http.server 8080');
}

// â”€â”€ Process raw rows into chart data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function process(rows) {
  const closes = rows.map(r=>r.close);
  const highs  = rows.map(r=>r.high);
  const lows   = rows.map(r=>r.low);
  const e20 = calcEMA(closes,20);
  const e50 = calcEMA(closes,50);
  const adx = calcADX(highs,lows,closes,14);
  return rows.map((r,i)=>{
    const reg = regime(r.close,e20[i],e50[i],adx[i]);
    const prev = i>0?rows[i-1].close:r.close;
    const chg  = r.close-prev;
    return { ...r, regime:reg, ema20:e20[i], ema50:e50[i], adx:adx[i],
             change:chg, changePct:chg/prev*100 };
  });
}

// â”€â”€ Monthly rollup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toMonthly(data) {
  const m={};
  data.forEach(d=>{
    const k=d.date.slice(0,7);
    if(!m[k]) m[k]={date:k,bull:0,bear:0,choppy:0,close:0,ema20:null,ema50:null};
    m[k].close=d.close; m[k].ema20=d.ema20; m[k].ema50=d.ema50;
    if(d.regime==='BULL') m[k].bull++;
    else if(d.regime==='BEAR') m[k].bear++;
    else m[k].choppy++;
  });
  return Object.values(m).sort((a,b)=>a.date.localeCompare(b.date));
}

// â”€â”€ Filter by year â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filtered() {
  if (currentYear==='ALL') return allData;
  return allData.filter(d=>d.date.startsWith(currentYear));
}

// â”€â”€ Build Chart.js datasets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPriceChart(data) {
  // Colour each point by regime
  const labels = data.map(d=>d.date);
  const prices = data.map(d=>d.close);
  const colors = data.map(d=>C[d.regime]||'#444');

  return {
    labels,
    datasets: [
      {
        label: 'SPY',
        data: prices,
        segment: {
          borderColor: ctx => {
            const d = data[ctx.p1DataIndex];
            return d ? (C[d.regime]||'#444') : '#444';
          }
        },
        borderWidth: 1.5,
        pointRadius: 0,
        tension: 0,
        fill: false,
        type: 'line',
        order: 1,
      },
      {
        label: 'EMA 20',
        data: data.map(d=>d.ema20),
        borderColor: '#60a5fa',
        borderWidth: 1,
        borderDash: [4,3],
        pointRadius: 0,
        tension: 0,
        fill: false,
        type: 'line',
        order: 2,
        spanGaps: true,
      },
      {
        label: 'EMA 50',
        data: data.map(d=>d.ema50),
        borderColor: '#a78bfa',
        borderWidth: 1,
        borderDash: [4,3],
        pointRadius: 0,
        tension: 0,
        fill: false,
        type: 'line',
        order: 3,
        spanGaps: true,
      }
    ]
  };
}

function buildRegimeChart(data) {
  const monthly = toMonthly(data);
  return {
    labels: monthly.map(m=>m.date),
    datasets: [
      { label:'ğŸ‚ Bull',   data:monthly.map(m=>m.bull),   backgroundColor:'#00d68f', stack:'a' },
      { label:'ã€°ï¸ Choppy', data:monthly.map(m=>m.choppy), backgroundColor:'#f0a500', stack:'a' },
      { label:'ğŸ» Bear',   data:monthly.map(m=>m.bear),   backgroundColor:'#ff4d6d', stack:'a' },
    ]
  };
}

// â”€â”€ Render chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChart() {
  const data = filtered();
  if (chartInst) { chartInst.destroy(); chartInst=null; }

  const ctx = document.getElementById('chart').getContext('2d');
  const isPrice = currentView==='price';

  const chartData = isPrice ? buildPriceChart(data) : buildRegimeChart(data);

  chartInst = new Chart(ctx, {
    type: isPrice ? 'line' : 'bar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: { duration: 300 },
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: {
          labels: {
            color:'#484f58', font:{family:"'Courier New',monospace",size:11},
            boxWidth:12, padding:16
          }
        },
        tooltip: {
          backgroundColor:'#0d1117',
          borderColor: '#30363d',
          borderWidth:1,
          titleColor:'#666',
          bodyColor:'#ccc',
          titleFont:{family:"'Courier New',monospace",size:11},
          bodyFont:{family:"'Courier New',monospace",size:11},
          callbacks: {
            afterBody: (items) => {
              if (!isPrice) return;
              const d = data[items[0].dataIndex];
              if (!d) return;
              const icons={BULL:'ğŸ‚ BULL',BEAR:'ğŸ» BEAR',CHOPPY:'ã€°ï¸ CHOPPY',UNKNOWN:'â“'};
              const chg=d.change>=0?'+':'';
              return [
                `Regime: ${icons[d.regime]||d.regime}`,
                `Change: ${chg}${d.change.toFixed(2)} (${chg}${d.changePct.toFixed(2)}%)`,
                d.adx?`ADX: ${d.adx.toFixed(1)}`:'',
              ].filter(Boolean);
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color:'#484f58',
            font:{family:"'Courier New',monospace",size:9},
            maxTicksLimit:12,
          },
          grid: { color:'#161b22' }
        },
        y: {
          ticks: {
            color:'#484f58',
            font:{family:"'Courier New',monospace",size:9},
            callback: v => isPrice ? `$${v}` : v,
          },
          grid: { color:'#161b22' }
        }
      }
    }
  });
}

// â”€â”€ Update stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const data = filtered();
  const c={BULL:0,BEAR:0,CHOPPY:0};
  data.forEach(d=>{if(c[d.regime]!==undefined)c[d.regime]++;});
  const total=data.length||1;
  document.getElementById('s-bull').textContent   = c.BULL;
  document.getElementById('s-bear').textContent   = c.BEAR;
  document.getElementById('s-choppy').textContent = c.CHOPPY;
  document.getElementById('s-bull-pct').textContent   = `${Math.round(c.BULL/total*100)}% Â· Trend Following`;
  document.getElementById('s-bear-pct').textContent   = `${Math.round(c.BEAR/total*100)}% Â· Hold Cash`;
  document.getElementById('s-choppy-pct').textContent = `${Math.round(c.CHOPPY/total*100)}% Â· Mean Reversion`;
}

// â”€â”€ Year buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildYearBtns() {
  const years=['ALL',...new Set(allData.map(d=>d.date.slice(0,4)))].sort((a,b)=>a==='ALL'?-1:a.localeCompare(b));
  const wrap=document.getElementById('year-btns');
  wrap.innerHTML='';
  years.forEach(y=>{
    const b=document.createElement('button');
    b.textContent=y; b.id='yr-'+y;
    if(y===currentYear) b.className='active';
    b.onclick=()=>{ currentYear=y; document.querySelectorAll('.year-btns button').forEach(x=>x.className=''); b.className='active'; updateStats(); renderChart(); };
    wrap.appendChild(b);
  });
}

// â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateTopBar() {
  const latest=allData[allData.length-1];
  if(!latest) return;
  const reg=latest.regime;
  const icons={BULL:'ğŸ‚ BULL',BEAR:'ğŸ» BEAR',CHOPPY:'ã€°ï¸ CHOPPY'};
  const pill=document.getElementById('regime-pill');
  pill.textContent=icons[reg]||reg;
  pill.style.display='inline-block';
  pill.style.color=C[reg]; pill.style.borderColor=C[reg]+'66'; pill.style.background=C[reg]+'15';
  document.getElementById('m-price').textContent=`$${latest.close.toFixed(2)}`;
  const chg=latest.change,pct=latest.changePct;
  const chgEl=document.getElementById('m-change');
  chgEl.textContent=`${chg>=0?'+':''}${chg.toFixed(2)} (${chg>=0?'+':''}${pct.toFixed(2)}%)`;
  chgEl.style.color=chg>=0?'#00d68f':'#ff4d6d';
  document.getElementById('m-ema20').textContent=latest.ema20?`$${latest.ema20.toFixed(2)}`:'-';
  document.getElementById('m-ema50').textContent=latest.ema50?`$${latest.ema50.toFixed(2)}`:'-';
  document.getElementById('m-adx').textContent=latest.adx?latest.adx.toFixed(1):'-';
  const strat={BULL:'Trend Following',BEAR:'Hold Cash',CHOPPY:'Mean Reversion'};
  const sEl=document.getElementById('m-strategy');
  sEl.textContent=strat[reg]||reg; sEl.style.color=C[reg];
  document.getElementById('top-bar').style.display='flex';
  document.getElementById('stats-row').style.display='flex';
}

// â”€â”€ View / gran toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(v) {
  currentView=v;
  document.getElementById('btn-price').className=v==='price'?'active-blue':'';
  document.getElementById('btn-regime').className=v==='regime'?'active':'';
  renderChart();
}
function setGran(g) {
  currentGran=g;
  document.getElementById('btn-daily').className=g==='daily'?'active':'';
  document.getElementById('btn-monthly').className=g==='monthly'?'active':'';
  renderChart();
}

// â”€â”€ Main load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  document.getElementById('loading').style.display='flex';
  document.getElementById('error-box').style.display='none';
  try {
    const rows = await fetchSPY();
    allData = process(rows);
    document.getElementById('loading').style.display='none';
    updateTopBar();
    buildYearBtns();
    updateStats();
    renderChart();
  } catch(e) {
    document.getElementById('loading').style.display='none';
    const eb=document.getElementById('error-box');
    eb.style.display='block';
    eb.innerHTML=`
      <strong>âš  Could not fetch live SPY data</strong><br><br>
      ${e.message}<br><br>
      <strong>Fix options:</strong><br>
      1. Run locally: <code>python -m http.server 8080</code> then open <code>http://localhost:8080/regime_chart.html</code><br>
      2. Or try again â€” Yahoo Finance sometimes temporarily blocks requests<br><br>
      <button onclick="loadData()" style="color:#00d68f;border-color:#00d68f44;margin-top:8px">â†» Retry</button>
    `;
  }
}

loadData();
</script>
</body>
</html>
